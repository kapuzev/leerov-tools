#!/bin/bash

# Функция активации Homebrew (аналог вашей brsw)
function brewActivate {
    if [ -d /opt/goinfre/$(whoami)/homebrew ]; then
        eval "$(/opt/goinfre/$(whoami)/homebrew/bin/brew shellenv)"
        chmod -R go-w "$(brew --prefix)/share/zsh"
        echo "Homebrew активирован"
    else
        echo "Homebrew не найден. Используйте brewSetup для установки"
        return 1
    fi
}

# Функция установки Homebrew (аналог else части вашей brsw)
function brewInstall {
    if [ -d /opt/goinfre/$(whoami)/homebrew ]; then
        echo "Homebrew уже установлен"
        brewActivate
        return 0
    fi
    
    echo "Установка Homebrew..."
    cd /opt/goinfre/$(whoami)
    git clone https://github.com/Homebrew/brew homebrew
    eval "$(/opt/goinfre/$(whoami)/homebrew/bin/brew shellenv)"
    brew update --force --quiet
    chmod -R go-w "$(brew --prefix)/share/zsh"
    brew install lcov
    echo "Homebrew успешно установлен"
}

# Функция удаления Homebrew
function brewUninstall {
    if [ -d /opt/goinfre/$(whoami)/homebrew ]; then
        echo "Удаление Homebrew..."
        rm -rf /opt/goinfre/$(whoami)/homebrew
        echo "Homebrew удален"
    else
        echo "Homebrew не установлен в /opt/goinfre/$(whoami)/homebrew"
    fi
}

# Основная функция (полный аналог вашей brsw)
function brewSetup {
    local brew_path="/opt/goinfre/$(whoami)/homebrew"
    
    if [ -d "$brew_path" ]; then
        eval "$($brew_path/bin/brew shellenv)"
        chmod -R go-w "$(brew --prefix)/share/zsh"
        echo "✓ Homebrew активирован"
        return 0
    fi
    
    echo "Быстрая установка Homebrew..."
    cd /opt/goinfre/$(whoami)
    
    # Оптимальный вариант: неглубокое клонирование
    git clone --depth=1 https://github.com/Homebrew/brew homebrew
    
    eval "$($brew_path/bin/brew shellenv)"
    brew update --force --quiet
    chmod -R go-w "$(brew --prefix)/share/zsh"
    
    # Тестируем функциональность
    if brew --version > /dev/null 2>&1; then
        echo "✓ Homebrew успешно установлен и готов к работе"
        echo "✓ Доступны: brew install, brew search, brew update и другие команды"
    else
        echo "❌ Что-то пошло не так"
        return 1
    fi
}

# Функция переустановки (удалить + установить)
function brewReinstall {
    brewUninstall
    brewInstall
}

brew_path="/opt/goinfre/$(whoami)/homebrew/bin"
if [[ ":$PATH:" != *":$brew_path:"* ]] && [ -d "$brew_path" ]; then
    export PATH="$brew_path:$PATH"
fi

source "installAppOnProfile"