#!/bin/bash

# –§—É–Ω–∫—Ü–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ Homebrew
function brewActivate {
    local user=$(whoami)
    local goinfre_path="/opt/goinfre/$user"
    local brew_path="$goinfre_path/homebrew"
    
    if [ -d "$brew_path" ]; then
        # 1. –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º Homebrew
        eval "$($brew_path/bin/brew shellenv)"
        
        # 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—É—Ç–∏ –¥–ª—è Cask
        export HOMEBREW_CASK_OPTS="--appdir=$goinfre_path/Applications --fontdir=$goinfre_path/Library/Fonts"
        
        # 3. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–µ—à –≤ goinfre
        export HOMEBREW_CACHE="$brew_path/cache"
        
        # 4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è 42
        export HOMEBREW_NO_ANALYTICS=1
        export HOMEBREW_NO_AUTO_UPDATE=1
        
        # 5. –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        mkdir -p "$goinfre_path/Applications" 2>/dev/null
        mkdir -p "$goinfre_path/Library/Fonts" 2>/dev/null
        mkdir -p "$HOMEBREW_CACHE" 2>/dev/null
        
        # 6. –°–æ–∑–¥–∞–µ–º —Å–∏–º–ª–∏–Ω–∫–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        if [ ! -L ~/Applications ] && [ ! -d ~/Applications ]; then
            ln -sf "$goinfre_path/Applications" ~/Applications 2>/dev/null
        fi
        
        if [ ! -L ~/Library/Fonts ] && [ ! -d ~/Library/Fonts ]; then
            ln -sf "$goinfre_path/Library/Fonts" ~/Library/Fonts 2>/dev/null
        fi
        
        # 7. –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–ª—è zsh –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
        chmod -R go-w "$(brew --prefix)/share/zsh" 2>/dev/null || true
        
        echo "‚úÖ Homebrew –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω"
        echo "üì¶ Cask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: $goinfre_path/Applications"
        echo "üóÑÔ∏è  –ö–µ—à brew: $HOMEBREW_CACHE"
        return 0
    else
        echo "‚ùå Homebrew –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏: $brew_path"
        echo "üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É: brewSetup"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Homebrew (–∞–Ω–∞–ª–æ–≥ else —á–∞—Å—Ç–∏ –≤–∞—à–µ–π brsw)
function brewInstall {
    if [ -d /opt/goinfre/$(whoami)/homebrew ]; then
        echo "Homebrew —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        brewActivate
        return 0
    fi
    
    echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Homebrew..."
    cd /opt/goinfre/$(whoami)
    git clone https://github.com/Homebrew/brew homebrew
    eval "$(/opt/goinfre/$(whoami)/homebrew/bin/brew shellenv)"
    brew update --force --quiet
    chmod -R go-w "$(brew --prefix)/share/zsh"
    brew install lcov
    echo "Homebrew —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
}

# –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è Homebrew
function brewUninstall {
    if [ -d /opt/goinfre/$(whoami)/homebrew ]; then
        echo "–£–¥–∞–ª–µ–Ω–∏–µ Homebrew..."
        rm -rf /opt/goinfre/$(whoami)/homebrew
        echo "Homebrew —É–¥–∞–ª–µ–Ω"
    else
        echo "Homebrew –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ /opt/goinfre/$(whoami)/homebrew"
    fi
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è (–ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–æ–≥ –≤–∞—à–µ–π brsw)
function brewSetup {
    local brew_path="/opt/goinfre/$(whoami)/homebrew"
    
    if [ -d "$brew_path" ]; then
        eval "$($brew_path/bin/brew shellenv)"
        chmod -R go-w "$(brew --prefix)/share/zsh"
        echo "‚úì Homebrew –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω"
        return 0
    fi
    
    echo "–ë—ã—Å—Ç—Ä–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Homebrew..."
    cd /opt/goinfre/$(whoami)
    
    # –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: –Ω–µ–≥–ª—É–±–æ–∫–æ–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
    git clone --depth=1 https://github.com/Homebrew/brew homebrew
    
    eval "$($brew_path/bin/brew shellenv)"
    brew update --force --quiet
    chmod -R go-w "$(brew --prefix)/share/zsh"
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
    if brew --version > /dev/null 2>&1; then
        echo "‚úì Homebrew —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ"
        echo "‚úì –î–æ—Å—Ç—É–ø–Ω—ã: brew install, brew search, brew update –∏ –¥—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã"
    else
        echo "‚ùå –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∏ (—É–¥–∞–ª–∏—Ç—å + —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å)
function brewReinstall {
    brewUninstall
    brewInstall
}

brew_path="/opt/goinfre/$(whoami)/homebrew/bin"
if [[ ":$PATH:" != *":$brew_path:"* ]] && [ -d "$brew_path" ]; then
    export PATH="$brew_path:$PATH"
fi

source "installAppOnProfile.sh"